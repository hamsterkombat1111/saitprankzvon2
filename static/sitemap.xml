from flask import Response, url_for
from datetime import datetime

@app.route('/sitemap.xml', methods=['GET'])
def sitemap():
    pages = []

    # Добавляем основные страницы сайта
    for rule in app.url_map.iter_rules():
        # Игнорируем маршруты с параметрами и служебные (static, api и т.п.)
        if "GET" in rule.methods and len(rule.arguments) == 0 and not rule.rule.startswith('/static'):
            url = url_for(rule.endpoint, _external=True)
            pages.append(url)

    # Формируем XML
    sitemap_xml = '<?xml version="1.0" encoding="UTF-8"?>\n'
    sitemap_xml += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n'

    for page in pages:
        sitemap_xml += '  <url>\n'
        sitemap_xml += f'    <loc>{page}</loc>\n'
        sitemap_xml += f'    <lastmod>{datetime.utcnow().date()}</lastmod>\n'
        sitemap_xml += '    <changefreq>weekly</changefreq>\n'
        sitemap_xml += '    <priority>0.8</priority>\n'
        sitemap_xml += '  </url>\n'

    sitemap_xml += '</urlset>'

    return Response(sitemap_xml, mimetype='application/xml')
